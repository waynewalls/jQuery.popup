/**
 *  jQuery.servercomm plugin -- UI and API for $.ajax() requests
 *  Copyright (c) 2013 Wayne Walls - wfwalls(at)gmail(dot)com
 *  Date: 26 May 2013
 *  @license MIT License or GNU General Public License (GPL) Version 2
 *  @author Wayne Walls
 *  @version 0.95
 *
 */
!function(window,document,$){var ie=function(){var undef,v=3,div=document.createElement("div"),all=div.getElementsByTagName("p");do{div.innerHTML="<!--[if gt IE "+(v+=1)+"]><p></p><![endif]-->"}while(all[0]);return v>4?v:undef}(),ie6=ie===6,styleText=[ie6?"body { background: url(images/clear1.gif) fixed; }":"","#sc_contactServerPrompt"+"{ font-weight:bold; text-align:center; left:0px; width:100%;",ie6?"position: absolute; top: expression((document.documentElement || document.body).scrollTop);":"position:fixed; top:0px;","}","#sc_contactServerPrompt img { vertical-align:-3px; }","#sc_contactServerPrompt span { cursor:default; }",".sc_hand { cursor:pointer; }",".sc_blue { padding:0 1em; background-color:#999; color:#8ef; }",".sc_yellow { padding:0 1em; background-color:#666; color:yellow; }",".sc_green { padding:0 1em; background-color:#666; color:#5f5; }",".sc_red { padding:0 1em; background-color:#FD2F00; color:white; }",".sc_inprocess { font-size:130%; font-weight:bold; color:white; background-color:red; padding:10px; border:solid 5px #d00; position:absolute }"].join(""),styleElement=$("<style />").attr("type","text/css"),contactPromptElement=$("<div />",{id:"sc_contactServerPrompt",html:"<span class='sc_blue'><img /> <span></span></span>"}),contactContainer=contactPromptElement.find("> span"),contactGear=contactPromptElement.find("img"),contactText=contactPromptElement.find("span span"),timerID,requestAttempts=1,activeRequest=null,inprocess=false,giveUp=function(errorMessage){var options=$.serverComm.options;errorMessage=errorMessage||"";if(options.giveupCallback){if($.isFunction(options.giveupCallback)){options.giveupCallback.call()}}requestAttempts=1;contactPromptElement.fadeTo("fast",0,function(){contactPromptElement.detach().css("opacity","");contactContainer.removeClass("sc_red").addClass("sc_blue").attr("title","");contactText.html(options.contactPromptText);contactGear.css("display","").attr("src",options.contactImagePath);inprocess=false})},ajaxProblem=function(errorMessage){var options=$.serverComm.options;errorMessage=errorMessage||"";activeRequest=null;if(options.errorCallback){if($.isFunction(options.errorCallback)){options.errorCallback.call(null,errorMessage,requestAttempts)}}requestAttempts+=1;if(requestAttempts<=$.serverComm.options.autoRetrys){contactContainer.removeClass("sc_blue").addClass("sc_yellow");contactGear.attr("src",options.problemImagePath);contactText.html("There's been a problem &mdash; Trying again. . . "+requestAttempts+" of "+$.serverComm.options.autoRetrys);inprocess=false;$.serverComm.contactServer()}else{contactContainer.removeClass("sc_yellow").addClass("sc_red").attr("title",errorMessage);contactGear.css({display:"none"});contactText.html(options.giveupPromptText+"&nbsp;&nbsp;<img class='sc_hand' src='"+options.closeBoxImagePath+"'>");$(document).one("click",function(){if(contactPromptElement.length===1){giveUp(errorMessage)}})}};$(document).ready(function(){var options=$.serverComm.options;if(styleElement[0].styleSheet){styleElement[0].styleSheet.cssText=styleText}else{styleElement.text(styleText)}styleElement.prependTo("head");contactText.html(options.contactPromptText);contactGear.attr("src",options.contactImagePath)});$.serverComm={optionDefaults:{url:"",method:"POST",dataObject:null,autoRetrys:4,autoTimeout:7e3,giveupCallback:null,errorCallback:null,successCallback:null,contactPromptText:"Contacting server",giveupPromptText:"The problem hasn't gone away &mdash; try again later",successPromptText:"Contacting server &mdash; SUCCESS!",contactImagePath:"images/busy999.gif",problemImagePath:"images/busy666.gif",closeBoxImagePath:"images/close.gif",responseSeparator:"|"},options:{url:"",method:"POST",dataObject:null,autoRetrys:4,autoTimeout:7e3,giveupCallback:null,errorCallback:null,successCallback:null,contactPromptText:"Contacting server",giveupPromptText:"The problem hasn't gone away &mdash; try again later",successPromptText:"Contacting server &mdash; SUCCESS!",contactImagePath:"images/busy999.gif",problemImagePath:"images/busy666.gif",closeBoxImagePath:"images/close.gif",responseSeparator:"|"},configure:function(config){config=config||{};this.optionDefaults=$.extend(this.optionDefaults,config)},activeConnection:function(){return activeRequest&&inprocess},inprocessWarning:function(){var $window=$(window),inprocessElement;inprocessElement=$("<div />",{"class":"sc_inprocess",text:"Please Wait!"}).appendTo("body");inprocessElement.css({top:($window.height()-inprocessElement.outerHeight())/2+$window.scrollTop(),left:($window.width()-inprocessElement.outerWidth())/2+$window.scrollLeft()});setTimeout(function(){inprocessElement.fadeTo("slow",0,function(){inprocessElement.remove()})},1e3)},contactServer:function(config){if(requestAttempts===1){config=config||{};this.options=$.extend({},this.optionDefaults,config)}timerID=setInterval(function(){if(!activeRequest&&!inprocess){clearInterval(timerID);inprocess=true;if(requestAttempts===1){contactText.html($.serverComm.options.contactPromptText);contactGear.attr("src",$.serverComm.options.contactImagePath)}contactPromptElement.appendTo("body");try{activeRequest=$.ajax({url:$.serverComm.options.url,type:$.serverComm.options.method,data:$.serverComm.options.dataObject,datatype:"text",timeout:$.serverComm.options.autoTimeout,error:function(xhr,jMessage,e){var errorMessage="";if(jMessage==="timeout"){errorMessage=jMessage}else{if(jMessage==="error"){errorMessage="internet error"}else{errorMessage="unknown"}}ajaxProblem(errorMessage)},success:function(response,status){var options=$.serverComm.options,responseStatus;responseStatus=response.indexOf(options.responseSeparator)===-1?response:response.split("|")[0];if(responseStatus!=="success"){ajaxProblem(responseStatus)}else{if(requestAttempts>1){activeRequest=null;contactPromptElement.detach();contactGear.css({display:"none"});contactContainer.removeClass("sc_yellow").addClass("sc_green");contactText.html(options.successPromptText);contactPromptElement.appendTo("body");setTimeout(function(){contactPromptElement.fadeTo("slow",0,function(){contactPromptElement.detach().css("opacity","");contactContainer.removeClass("sc_green").addClass("sc_blue");contactText.html(options.contactPromptText);contactGear.css("display","").attr("src",options.contactImagePath);inprocess=false})},2e3)}else{activeRequest=null;setTimeout(function(){contactPromptElement.fadeTo("slow",0,function(){contactPromptElement.detach().css("opacity","");inprocess=false})},750)}if($.serverComm.options.successCallback){if($.isFunction($.serverComm.options.successCallback)){$.serverComm.options.successCallback.call(null,response,requestAttempts)}}requestAttempts=1}}})}catch(e){ajaxProblem("ajax failure")}}},100)}}}(window,document,jQuery);